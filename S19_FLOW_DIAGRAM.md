# S19: Diagramme de flux des tÃ©lÃ©chargements sÃ©curisÃ©s

## ğŸ”„ Flux complet du systÃ¨me

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FLUX DE TÃ‰LÃ‰CHARGEMENT                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰TAPE 1  â”‚  ACHAT DU PRODUIT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚   User visite /catalog
    â”‚   User sÃ©lectionne un produit
    â”‚   User clique "Acheter"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend: Cart.tsx     â”‚
â”‚  - Produit dans panier  â”‚
â”‚  - User clique Checkout â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ POST /checkout/init
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: checkout.ts       â”‚
â”‚  - CrÃ©e order (PENDING) â”‚
â”‚  - GÃ©nÃ¨re session       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Redirect to Stripe
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stripe Checkout        â”‚
â”‚  - User paie            â”‚
â”‚  - Payment Intent       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Webhook
    â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰TAPE 2  â”‚  GÃ‰NÃ‰RATION DES LIENS SÃ‰CURISÃ‰S
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: stripeWebhook.ts                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Receive webhook event          â”‚  â”‚
â”‚  â”‚ 2. Verify signature               â”‚  â”‚
â”‚  â”‚ 3. Extract payment data           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                        â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Create Order (status: PAID)       â”‚  â”‚
â”‚  â”‚ - buyerEmail                      â”‚  â”‚
â”‚  â”‚ - totalCents                      â”‚  â”‚
â”‚  â”‚ - items (products + licenses)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                        â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ generateDownloadLinksForOrder()   â”‚  â”‚
â”‚  â”‚ (services/downloads.ts)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service: downloads.ts                  â”‚
â”‚  Pour chaque OrderItem:                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Generate random token (32B)    â”‚  â”‚
â”‚  â”‚ 2. Set expiration (+48h)          â”‚  â”‚
â”‚  â”‚ 3. Create Download record         â”‚  â”‚
â”‚  â”‚    - orderId                      â”‚  â”‚
â”‚  â”‚    - orderItemId                  â”‚  â”‚
â”‚  â”‚    - token (unique)               â”‚  â”‚
â”‚  â”‚    - expiresAt                    â”‚  â”‚
â”‚  â”‚    - maxDownloads: 3              â”‚  â”‚
â”‚  â”‚    - downloadCount: 0             â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 4. Sign JWT token                 â”‚  â”‚
â”‚  â”‚    payload: {                     â”‚  â”‚
â”‚  â”‚      downloadId,                  â”‚  â”‚
â”‚  â”‚      orderId,                     â”‚  â”‚
â”‚  â”‚      orderItemId,                 â”‚  â”‚
â”‚  â”‚      productId                    â”‚  â”‚
â”‚  â”‚    }                              â”‚  â”‚
â”‚  â”‚    secret: JWT_SECRET             â”‚  â”‚
â”‚  â”‚    expires: 48h                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Returns: { orderId, downloads: [...] }
    â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰TAPE 3  â”‚  AFFICHAGE DES LIENS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Stripe redirects to /checkout/confirmation?cid=ORDER_ID
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend: CheckoutConfirmation.tsx     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Extract orderId from URL       â”‚  â”‚
â”‚  â”‚ 2. useDownloads(orderId)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                        â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Hook: useDownloads.ts             â”‚  â”‚
â”‚  â”‚ GET /api/orders/:orderId/downloadsâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Fetch download links
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: routes/downloads.ts               â”‚
â”‚  GET /api/orders/:orderId/downloads     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Find order with items + products  â”‚  â”‚
â”‚  â”‚ For each item:                    â”‚  â”‚
â”‚  â”‚   - Get or create Download        â”‚  â”‚
â”‚  â”‚   - Generate JWT token            â”‚  â”‚
â”‚  â”‚   - Return download info:         â”‚  â”‚
â”‚  â”‚     * productTitle                â”‚  â”‚
â”‚  â”‚     * downloadToken               â”‚  â”‚
â”‚  â”‚     * downloadUrl                 â”‚  â”‚
â”‚  â”‚     * expiresAt                   â”‚  â”‚
â”‚  â”‚     * downloadsRemaining          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Returns JSON
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend renders:                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¥ Vos tÃ©lÃ©chargements            â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚ â”‚ Kit 808 Foundation          â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Expire: 16 nov 2025, 14:30 â”‚   â”‚  â”‚
â”‚  â”‚ â”‚ Restants: 3 / 3             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚                             â”‚   â”‚  â”‚
â”‚  â”‚ â”‚        [TÃ©lÃ©charger]        â”‚   â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ User clicks "TÃ©lÃ©charger"
    â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰TAPE 4  â”‚  TÃ‰LÃ‰CHARGEMENT SÃ‰CURISÃ‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend: handleDownload()             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Build download URL             â”‚  â”‚
â”‚  â”‚    /api/downloads/:token          â”‚  â”‚
â”‚  â”‚ 2. Create temporary <a> element   â”‚  â”‚
â”‚  â”‚ 3. Click to trigger download      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ GET /api/downloads/:token
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: routes/downloads.ts               â”‚
â”‚  GET /api/downloads/:token              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ VALIDATION (validateDownloadToken)â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 1. Verify JWT signature           â”‚  â”‚
â”‚  â”‚    âœ— Invalid â†’ 403 Forbidden      â”‚  â”‚
â”‚  â”‚    âœ“ Valid â†’ Continue             â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 2. Fetch Download from DB         â”‚  â”‚
â”‚  â”‚    âœ— Not found â†’ 403              â”‚  â”‚
â”‚  â”‚    âœ“ Found â†’ Continue             â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 3. Check expiration               â”‚  â”‚
â”‚  â”‚    if (now > expiresAt)           â”‚  â”‚
â”‚  â”‚       âœ— â†’ 403 "Link expired"      â”‚  â”‚
â”‚  â”‚    âœ“ Not expired â†’ Continue       â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 4. Check download count           â”‚  â”‚
â”‚  â”‚    if (count >= maxDownloads)     â”‚  â”‚
â”‚  â”‚       âœ— â†’ 403 "Limit reached"     â”‚  â”‚
â”‚  â”‚    âœ“ Available â†’ Continue         â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 5. Get product file URL           â”‚  â”‚
â”‚  â”‚    âœ— No file â†’ 404                â”‚  â”‚
â”‚  â”‚    âœ“ File exists â†’ Continue       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                        â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RECORD DOWNLOAD                   â”‚  â”‚
â”‚  â”‚ (recordDownload)                  â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ 1. Get client IP                  â”‚  â”‚
â”‚  â”‚ 2. Update Download:               â”‚  â”‚
â”‚  â”‚    - downloadCount += 1           â”‚  â”‚
â”‚  â”‚    - ipAddresses.push(clientIP)   â”‚  â”‚
â”‚  â”‚    - downloadDates.push(now)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                        â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STREAM FILE                       â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ If fileUrl starts with:           â”‚  â”‚
â”‚  â”‚   ./public â†’ Stream local file    â”‚  â”‚
â”‚  â”‚   https:// â†’ Redirect to S3       â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ Set headers:                      â”‚  â”‚
â”‚  â”‚   Content-Disposition: attachment â”‚  â”‚
â”‚  â”‚   Content-Type: octet-stream      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ File stream
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User's Browser         â”‚
â”‚  - Receives file        â”‚
â”‚  - Saves to disk        â”‚
â”‚  - Download complete âœ… â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           SÃ‰CURITÃ‰ & TRACKING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: Table Download                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ id:             "abc-123-def-456"                              â”‚ â”‚
â”‚  â”‚ orderId:        "order-789"                                    â”‚ â”‚
â”‚  â”‚ orderItemId:    "item-012"                                     â”‚ â”‚
â”‚  â”‚ token:          "a3f2...b9c1" (32 bytes hex)                   â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ expiresAt:      2025-11-16 14:30:00  â°                       â”‚ â”‚
â”‚  â”‚ maxDownloads:   3                                              â”‚ â”‚
â”‚  â”‚ downloadCount:  2                     ğŸ‘ï¸                       â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ ipAddresses:    ["192.168.1.1", "192.168.1.1"]  ğŸ“           â”‚ â”‚
â”‚  â”‚ downloadDates:  ["2025-11-14 10:30", "2025-11-15 16:45"]  ğŸ“… â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ createdAt:      2025-11-14 10:00:00                            â”‚ â”‚
â”‚  â”‚ updatedAt:      2025-11-15 16:45:00                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROTECTION MULTI-COUCHES                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Couche 1: JWT Signature                                        â”‚ â”‚
â”‚  â”‚   - Token signÃ© avec HMAC-SHA256                               â”‚ â”‚
â”‚  â”‚   - Impossible Ã  falsifier sans JWT_SECRET                     â”‚ â”‚
â”‚  â”‚   - VÃ©rification cryptographique                               â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ Couche 2: Expiration temporelle                                â”‚ â”‚
â”‚  â”‚   - Dans le JWT (exp claim)                                    â”‚ â”‚
â”‚  â”‚   - Dans la DB (expiresAt)                                     â”‚ â”‚
â”‚  â”‚   - Double vÃ©rification                                        â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ Couche 3: Limite de tÃ©lÃ©chargements                            â”‚ â”‚
â”‚  â”‚   - Compteur en DB                                             â”‚ â”‚
â”‚  â”‚   - IncrÃ©mentÃ© atomiquement                                    â”‚ â”‚
â”‚  â”‚   - BloquÃ© aprÃ¨s max                                           â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚ Couche 4: IP Tracking                                          â”‚ â”‚
â”‚  â”‚   - Toutes les IPs enregistrÃ©es                                â”‚ â”‚
â”‚  â”‚   - Dates de tÃ©lÃ©chargement                                    â”‚ â”‚
â”‚  â”‚   - Audit trail complet                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          SCÃ‰NARIOS D'UTILISATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… SCÃ‰NARIO 1: TÃ©lÃ©chargement normal
   User achÃ¨te â†’ ReÃ§oit lien â†’ TÃ©lÃ©charge (1/3) â†’ âœ… Success

âœ… SCÃ‰NARIO 2: TÃ©lÃ©chargements multiples (dans la limite)
   Download #1 â†’ âœ… (1/3)
   Download #2 â†’ âœ… (2/3)
   Download #3 â†’ âœ… (3/3)

âŒ SCÃ‰NARIO 3: DÃ©passement de limite
   Download #1 â†’ âœ… (1/3)
   Download #2 â†’ âœ… (2/3)
   Download #3 â†’ âœ… (3/3)
   Download #4 â†’ âŒ 403 "Download limit reached"

âŒ SCÃ‰NARIO 4: Lien expirÃ©
   User achÃ¨te le 14 nov
   User essaie de tÃ©lÃ©charger le 17 nov (>48h)
   â†’ âŒ 403 "Download link has expired"

âŒ SCÃ‰NARIO 5: Token falsifiÃ©
   Attacker modifie le JWT
   â†’ âŒ 403 "Invalid token" (signature invalide)

âŒ SCÃ‰NARIO 6: Token volÃ© (mais IP diffÃ©rente)
   User 1 tÃ©lÃ©charge depuis IP A â†’ âœ… EnregistrÃ©
   User 2 essaie avec mÃªme token depuis IP B â†’ âš ï¸ Fonctionne mais suivi
   â†’ Admin peut voir multiples IPs dans le dashboard

ğŸ” SCÃ‰NARIO 7: Monitoring & dÃ©tection d'abus
   Admin vÃ©rifie les downloads avec >2 IPs diffÃ©rentes
   â†’ Identifie les partages de liens suspects
   â†’ Peut contacter le client ou bloquer


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         POINTS D'INTÃ‰GRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FICHIERS MODIFIÃ‰S/CRÃ‰Ã‰S                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Backend (apps/api/)                                               â”‚
â”‚  â”œâ”€ prisma/schema.prisma          [MODIFIÃ‰]                        â”‚
â”‚  â”‚  â””â”€ + Download model                                            â”‚
â”‚  â”‚  â””â”€ + Product.fileUrl, fileSizeMb                               â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â”œâ”€ src/services/downloads.ts     [NOUVEAU]                        â”‚
â”‚  â”‚  â””â”€ Logique mÃ©tier des tÃ©lÃ©chargements                          â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â”œâ”€ src/routes/downloads.ts       [NOUVEAU]                        â”‚
â”‚  â”‚  â””â”€ Endpoints API                                               â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â”œâ”€ src/index.ts                  [MODIFIÃ‰]                        â”‚
â”‚  â”‚  â””â”€ + app.use("/api", downloadsRouter)                          â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â”œâ”€ src/routes/stripeWebhook.ts   [MODIFIÃ‰]                        â”‚
â”‚  â”‚  â””â”€ + generateDownloadLinksForOrder()                           â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â””â”€ package.json                  [MODIFIÃ‰]                        â”‚
â”‚     â””â”€ + jsonwebtoken, @types/jsonwebtoken                         â”‚
â”‚                                                                    â”‚
â”‚  Frontend (apps/web/)                                              â”‚
â”‚  â”œâ”€ src/hooks/useDownloads.ts     [NOUVEAU]                        â”‚
â”‚  â”‚  â””â”€ Hook pour charger les tÃ©lÃ©chargements                       â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â””â”€ src/pages/CheckoutConfirmation.tsx [MODIFIÃ‰]                   â”‚
â”‚     â””â”€ Interface utilisateur complÃ¨te                              â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Points clÃ©s Ã  retenir

1. **SÃ©curitÃ© multicouche**: JWT + Expiration + Limite + Tracking
2. **GÃ©nÃ©ration automatique**: Webhook Stripe â†’ CrÃ©ation des liens
3. **UX fluide**: Page de confirmation â†’ Clic â†’ TÃ©lÃ©chargement
4. **Audit complet**: Chaque tÃ©lÃ©chargement tracÃ© (IP + date)
5. **Production-ready**: Support local + S3, configurable, scalable

## ğŸ“Š MÃ©triques de succÃ¨s

- âœ… SÃ©curitÃ©: 0 fuite possible (liens signÃ©s + expiration)
- âœ… UX: <1 seconde pour afficher les liens
- âœ… FiabilitÃ©: Tout enregistrÃ© en DB, reprise possible
- âœ… Audit: 100% des tÃ©lÃ©chargements tracÃ©s
- âœ… ScalabilitÃ©: PrÃªt pour des milliers d'utilisateurs

---

**PrÃªt Ã  dÃ©marrer?** â†’ Voir `S19_QUICK_START.md`


