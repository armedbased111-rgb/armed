# S20 : Diagramme de flux - Licences et packages personnalisÃ©s

## ğŸ“Š Vue d'ensemble du systÃ¨me

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SYSTÃˆME DE PACKAGES S20                       â”‚
â”‚                                                                   â”‚
â”‚  [Commande payÃ©e] â†’ [GÃ©nÃ©ration package] â†’ [TÃ©lÃ©chargement]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flux principal

### 1. Page de confirmation de commande

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CheckoutConfirmation.tsx                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1. RÃ©cupÃ©ration orderId depuis PaymentIntent                    â”‚
â”‚     â””â”€> useOrderByPaymentIntent(paymentIntentId)                â”‚
â”‚                                                                   â”‚
â”‚  2. VÃ©rification du statut du package                            â”‚
â”‚     â””â”€> useDownloadPackage(orderId)                             â”‚
â”‚          â””â”€> GET /api/orders/:orderId/package/status            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Package existe ?                                 â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                          â”‚                           â”‚
â”‚          OUI                        NON                          â”‚
â”‚           â”‚                          â”‚                           â”‚
â”‚           â–¼                          â–¼                           â”‚
â”‚  Afficher bouton           Afficher bouton                       â”‚
â”‚  "TÃ©lÃ©charger"            "GÃ©nÃ©rer package"                      â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. GÃ©nÃ©ration du package (premiÃ¨re fois)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Clic sur "GÃ©nÃ©rer mon package"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/orders/:orderId/package                                â”‚
â”‚  â”œâ”€> packageGenerator.getOrCreateDownloadPackage(orderId)        â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 1. VÃ©rifier si package existe dÃ©jÃ                           â”‚
â”‚  â”‚      â””â”€> OUI + non expirÃ© â†’ Retourner existant                â”‚
â”‚  â”‚      â””â”€> NON â†’ Continuer                                      â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 2. RÃ©cupÃ©rer commande + items + produits                    â”‚
â”‚  â”‚      â””â”€> prisma.order.findUnique({ include: { items: ... }}) â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 3. GÃ©nÃ©rer PDF de licence                                   â”‚
â”‚  â”‚      â””â”€> generateOrderLicensePDF()                            â”‚
â”‚  â”‚           â”œâ”€ Infos acheteur                                   â”‚
â”‚  â”‚           â”œâ”€ Liste des produits                               â”‚
â”‚  â”‚           â”œâ”€ Types de licence                                 â”‚
â”‚  â”‚           â”œâ”€ Droits et restrictions                           â”‚
â”‚  â”‚           â””â”€ Hash de traÃ§abilitÃ© (invisible)                  â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 4. CrÃ©er fichier hash (.package_info.json)                 â”‚
â”‚  â”‚      â””â”€> JSON avec packageHash, orderId, items               â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 5. CrÃ©er ZIP                                                â”‚
â”‚  â”‚      â””â”€> archiver                                             â”‚
â”‚  â”‚           â”œâ”€ Ajouter LICENSE-{orderId}.pdf                    â”‚
â”‚  â”‚           â”œâ”€ Ajouter .package_info.json                       â”‚
â”‚  â”‚           â””â”€ Ajouter tous les fichiers audio                  â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 6. Calculer taille fichier                                  â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 7. DÃ©placer vers public/packages/                           â”‚
â”‚  â”‚      â””â”€> reboul-{orderId}-{hash}.zip                          â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> 8. CrÃ©er/Mettre Ã  jour dans DB                              â”‚
â”‚  â”‚      â””â”€> prisma.downloadPackage.upsert()                      â”‚
â”‚  â”‚           â”œâ”€ zipUrl                                           â”‚
â”‚  â”‚           â”œâ”€ zipHash                                          â”‚
â”‚  â”‚           â”œâ”€ licenseUrl                                       â”‚
â”‚  â”‚           â”œâ”€ fileSizeMb                                       â”‚
â”‚  â”‚           â”œâ”€ expiresAt (now + 48h)                            â”‚
â”‚  â”‚           â””â”€ maxDownloads (3)                                 â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€> 9. Retourner infos package                                  â”‚
â”‚           â”œâ”€ packageId                                            â”‚
â”‚           â”œâ”€ zipHash                                              â”‚
â”‚           â”œâ”€ fileSizeMb                                           â”‚
â”‚           â”œâ”€ expiresAt                                            â”‚
â”‚           â””â”€ downloadUrl                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Frontend affiche bouton "TÃ©lÃ©charger"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. TÃ©lÃ©chargement du package

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Clic sur "TÃ©lÃ©charger le package"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /api/orders/:orderId/package/download                        â”‚
â”‚  â”œâ”€> validatePackageDownload(orderId)                            â”‚
â”‚  â”‚    â”‚                                                           â”‚
â”‚  â”‚    â”œâ”€> VÃ©rifier que package existe                            â”‚
â”‚  â”‚    â”œâ”€> VÃ©rifier non expirÃ©                                    â”‚
â”‚  â”‚    â”œâ”€> VÃ©rifier downloadCount < maxDownloads                  â”‚
â”‚  â”‚    â””â”€> VÃ©rifier zipUrl existe                                 â”‚
â”‚  â”‚                                                                â”‚
â”‚  â”œâ”€> recordPackageDownload(packageId)                            â”‚
â”‚  â”‚    â””â”€> IncrÃ©menter downloadCount                              â”‚
â”‚  â”‚    â””â”€> Mettre Ã  jour lastDownloadAt                           â”‚
â”‚  â”‚                                                                â”‚
â”‚  â””â”€> Stream fichier ZIP vers client                              â”‚
â”‚       â””â”€> fs.createReadStream(zipPath).pipe(res)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Navigateur tÃ©lÃ©charge le ZIP                         â”‚
â”‚          reboul-order-{orderId}.zip                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ Structure du package gÃ©nÃ©rÃ©

```
reboul-{orderId}-{hash-court}.zip
â”‚
â”œâ”€â”€ LICENSE-{orderId}.pdf
â”‚   â”œâ”€ En-tÃªte "CERTIFICAT DE LICENCE"
â”‚   â”œâ”€ Informations commande
â”‚   â”‚   â”œâ”€ NumÃ©ro de commande
â”‚   â”‚   â”œâ”€ Titulaire (email)
â”‚   â”‚   â”œâ”€ Date d'achat
â”‚   â”‚   â””â”€ Montant payÃ©
â”‚   â”œâ”€ Produits sous licence
â”‚   â”‚   â””â”€ Liste avec type de licence
â”‚   â”œâ”€ Droits accordÃ©s
â”‚   â”œâ”€ Restrictions
â”‚   â””â”€ Hash de traÃ§abilitÃ© (invisible)
â”‚
â”œâ”€â”€ .package_info.json (mÃ©tadonnÃ©es cachÃ©es)
â”‚   {
â”‚     "packageHash": "abc123...",
â”‚     "orderId": "...",
â”‚     "buyerEmail": "...",
â”‚     "generatedAt": "2025-11-14T...",
â”‚     "items": [
â”‚       {
â”‚         "productId": "...",
â”‚         "productTitle": "...",
â”‚         "licenseType": "STANDARD"
â”‚       }
â”‚     ]
â”‚   }
â”‚
â””â”€â”€ {nom-produit-sanitized}-{fichier}.wav
    (tous les fichiers audio de la commande)
```

## ğŸ” SÃ©curitÃ© et traÃ§abilitÃ©

### Hash unique
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      GÃ©nÃ©ration du hash SHA-256      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Inputs:                             â”‚
â”‚  â”œâ”€ orderId                          â”‚
â”‚  â”œâ”€ buyerEmail                       â”‚
â”‚  â”œâ”€ timestamp (ISO)                  â”‚
â”‚  â””â”€ random()                         â”‚
â”‚                                      â”‚
â”‚  Output:                             â”‚
â”‚  â””â”€ 64 caractÃ¨res hex               â”‚
â”‚      (ex: a3b5c7d9...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    StockÃ© dans 3 endroits:
    â”œâ”€ DB: DownloadPackage.zipHash
    â”œâ”€ ZIP: .package_info.json
    â””â”€ PDF: texte invisible (gris clair)
```

### Validation Ã  chaque tÃ©lÃ©chargement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tentative de tÃ©lÃ©chargement        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  validatePackageDownload()           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Package existe ?                 â”‚
â”‚     â””â”€> NON â†’ âŒ 404                 â”‚
â”‚                                      â”‚
â”‚  2. ExpirÃ© ?                         â”‚
â”‚     â””â”€> OUI â†’ âŒ 403 "expired"       â”‚
â”‚                                      â”‚
â”‚  3. Limite atteinte ?                â”‚
â”‚     â””â”€> OUI â†’ âŒ 403 "limit reached" â”‚
â”‚                                      â”‚
â”‚  4. zipUrl existe ?                  â”‚
â”‚     â””â”€> NON â†’ âŒ 404 "not generated" â”‚
â”‚                                      â”‚
â”‚  5. Fichier existe sur disque ?      â”‚
â”‚     â””â”€> NON â†’ âŒ 404 "file not found"â”‚
â”‚                                      â”‚
â”‚  âœ… Tous les checks OK               â”‚
â”‚  â””â”€> Autoriser tÃ©lÃ©chargement        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ Ã‰tats du package

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CYCLE DE VIE D'UN PACKAGE                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    INEXISTANT
        â”‚
        â”‚ User clique "GÃ©nÃ©rer"
        â–¼
    GÃ‰NÃ‰RATION
        â”‚
        â”‚ Success
        â–¼
    DISPONIBLE â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚
        â”‚ Download     â”‚ 48h passent
        â”‚              â”‚
        â–¼              â–¼
    UTILISÃ‰        EXPIRÃ‰
        â”‚
        â”‚ 3 downloads
        â–¼
    Ã‰PUISÃ‰


Ã‰tats possibles:
â”œâ”€ INEXISTANT      : Pas encore de package pour cette commande
â”œâ”€ GÃ‰NÃ‰RATION      : En cours de crÃ©ation
â”œâ”€ DISPONIBLE      : PrÃªt Ã  tÃ©lÃ©charger (downloadCount < max, non expirÃ©)
â”œâ”€ UTILISÃ‰         : Au moins 1 tÃ©lÃ©chargement, mais encore disponible
â”œâ”€ Ã‰PUISÃ‰          : Limite de tÃ©lÃ©chargements atteinte
â””â”€ EXPIRÃ‰          : DÃ©passÃ© la date d'expiration
```

## ğŸ¨ Interface utilisateur - Ã‰tats

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Page CheckoutConfirmation                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ Package complet (RecommandÃ©)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ [Ã‰tat 1: INEXISTANT]                                        â”‚
â”‚   "Votre package n'est pas encore gÃ©nÃ©rÃ©..."                â”‚
â”‚   [Bouton: GÃ©nÃ©rer mon package personnalisÃ©]                â”‚
â”‚                                                              â”‚
â”‚ [Ã‰tat 2: GÃ‰NÃ‰RATION]                                        â”‚
â”‚   "ğŸ”„ GÃ©nÃ©ration en cours..."                               â”‚
â”‚   [Bouton disabled]                                          â”‚
â”‚                                                              â”‚
â”‚ [Ã‰tat 3: DISPONIBLE]                                        â”‚
â”‚   Taille: 15.5 MB                                           â”‚
â”‚   TÃ©lÃ©chargements: 2/3 restants                             â”‚
â”‚   Hash: a3b5c7d9...                                         â”‚
â”‚   [Bouton vert: â¬‡ï¸ TÃ©lÃ©charger le package complet]         â”‚
â”‚                                                              â”‚
â”‚ [Ã‰tat 4: Ã‰PUISÃ‰]                                            â”‚
â”‚   "âš ï¸ Limite de tÃ©lÃ©chargements atteinte"                  â”‚
â”‚   [Bouton disabled]                                          â”‚
â”‚                                                              â”‚
â”‚ [Ã‰tat 5: EXPIRÃ‰]                                            â”‚
â”‚   "âš ï¸ Package expirÃ©. Contactez le support"                â”‚
â”‚   [Bouton disabled]                                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¥ TÃ©lÃ©chargements individuels                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ou tÃ©lÃ©chargez chaque fichier sÃ©parÃ©ment                    â”‚
â”‚ (sans licence PDF)                                           â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚ Kit 808 Foundation                        â”‚              â”‚
â”‚ â”‚ Expire: 16 novembre â€¢ 2/3 restants        â”‚              â”‚
â”‚ â”‚                          [TÃ©lÃ©charger]    â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— IntÃ©grations

### Base de donnÃ©es (Prisma)

```
Order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€ id            â”‚
â”œâ”€ buyerEmail    â”‚         DownloadPackage
â”œâ”€ status        â”‚         â”œâ”€ id
â”œâ”€ totalCents    â”‚         â”œâ”€ orderId â—„â”€â”€â”€â”€â”€â”˜
â””â”€ items []      â”‚         â”œâ”€ zipUrl
      â”‚          â”‚         â”œâ”€ zipHash
      â”‚          â”‚         â”œâ”€ licenseUrl
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”œâ”€ fileSizeMb
                 â”‚         â”œâ”€ expiresAt
                 â”‚         â”œâ”€ downloadCount
                 â”‚         â””â”€ maxDownloads
                 â”‚
OrderItem        â”‚
â”œâ”€ id            â”‚
â”œâ”€ orderId â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€ productId â”€â”€â”€â”€â”
â”œâ”€ licenseType   â”‚
â””â”€ priceCents    â”‚
                 â”‚
Product          â”‚
â”œâ”€ id â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€ title
â”œâ”€ fileUrl â”€â”€â”€â”€â”€â”€â–º UtilisÃ© pour ZIP
â””â”€ slug
```

### SystÃ¨me de fichiers

```
apps/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ temp/                    (temporaire, auto-nettoyÃ©)
â”‚   â”‚   â””â”€â”€ {orderId}/
â”‚   â”‚       â”œâ”€â”€ license.pdf
â”‚   â”‚       â”œâ”€â”€ .package_info.json
â”‚   â”‚       â””â”€â”€ reboul-{orderId}.zip
â”‚   â”‚
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ services/
â”‚           â”œâ”€â”€ license.ts       (gÃ©nÃ©ration PDF)
â”‚           â””â”€â”€ packageGenerator.ts (gÃ©nÃ©ration ZIP)
â”‚
â””â”€â”€ web/
    â””â”€â”€ public/
        â”œâ”€â”€ downloads/           (fichiers audio originaux)
        â”‚   â””â”€â”€ *.wav, *.mp3
        â”‚
        â””â”€â”€ packages/            (packages gÃ©nÃ©rÃ©s)
            â”œâ”€â”€ reboul-{orderId}-{hash}.zip
            â””â”€â”€ license-{orderId}.pdf
```

## ğŸ¯ Points clÃ©s

1. **GÃ©nÃ©ration Ã  la demande** : Le package n'est crÃ©Ã© que quand l'utilisateur clique
2. **RÃ©utilisation** : Si le package existe et n'est pas expirÃ©, on le retourne
3. **SÃ©curitÃ© multicouche** : Validation Ã  chaque Ã©tape
4. **TraÃ§abilitÃ© triple** : Hash stockÃ© en DB, ZIP et PDF
5. **ExpÃ©rience utilisateur** : Ã‰tats clairs, feedback visuel
6. **Nettoyage automatique** : Fichiers temporaires supprimÃ©s aprÃ¨s gÃ©nÃ©ration

## ğŸš€ Ã‰volutions possibles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GÃ©nÃ©ration actuelle â”‚ (Synchrone)
â”‚  â”œâ”€ User clique      â”‚
â”‚  â”œâ”€ Wait 3-5s        â”‚
â”‚  â””â”€ Package prÃªt     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰volution future    â”‚ (Asynchrone avec queue)
â”‚  â”œâ”€ User clique      â”‚
â”‚  â”œâ”€ Job en queue     â”‚
â”‚  â”œâ”€ Email notif      â”‚
â”‚  â””â”€ Download ready   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

